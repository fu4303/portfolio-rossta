<!doctype html>
<html>
  <head>
    <title>When Your Fat Models Need to Go on a Diet, Part 2 - rossta.net</title>
<meta name="description" content="Ross Kaffenberger writes about software engineering, computer programming, and web development in Ruby, Javascript, and Elixir" />
<meta name="keywords" content="Ruby, Rails" />
<meta name="site" content="rossta.net" />
<meta property="og:site_name" content="rossta.net" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="Ross Kaffenberger" />
<meta name="twitter:description" content="Ross Kaffenberger writes about software engineering, computer programming, and web development in Ruby, Javascript, and Elixir" />
<meta name="twitter:image:src" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo-d2559811.jpg" />
<meta name="twitter:title" content="When Your Fat Models Need to Go on a Diet, Part 2" />
<meta property="og:description" content="Ross Kaffenberger writes about software engineering, computer programming, and web development in Ruby, Javascript, and Elixir" />
<meta property="og:image" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo-d2559811.jpg" />
<meta property="og:title" content="When Your Fat Models Need to Go on a Diet, Part 2" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon"     href="/apple-touch-icon.png" />
    <link rel="icon"                 href="/touch-icon-192x192.png" />
    <link rel="icon" sizes="192x192" href="/touch-icon-192x192.png" />
    <link rel="icon" sizes="144x144" href="/touch-icon-144x144.png" />
    <link rel="icon" sizes="96x96"   href="/touch-icon-96x96.png" />
    <link rel="icon" sizes="72x72"   href="/touch-icon-72x72.png" />

    <link rel="apple-touch-icon"      sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32"   href="/favicon-32x32-9132b2a2.png">
    <link rel="icon" type="image/png" sizes="16x16"   href="/favicon-16x16-6acb8f84.png">

    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab-5cdca7ae.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    <link rel="pingback" href="https://webmention.io/rossta.net/xmlrpc" />
    <link rel="webmention" href="https://webmention.io/rossta.net/webmention" />

    <script type="text/javascript" src="//use.typekit.net/ned0mml.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <link href="/assets/stylesheets/app.bundle-ee59a235.css" rel="stylesheet" />
  </head>
  <body id="application" class="typekit">
    <nav id="welcome-nav" class="top-bar" data-topbar>
  <ul class="title-area">
    <li class="name">
      <h1><a class="logo" href="/"><img src="/assets/images/turtle-logo-096698b6.svg" alt="Turtle logo" /><span>rossta.net</span></a></h1>
    </li>
    <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
  </ul>

  <section class="top-bar-section">
    <ul class="left">
      <li class="nav"><a href="/blog">blog</a></li>
      <li class="nav"><a href="/series">series</a></li>
      <li class="nav"><a href="/talks">talks</a></li>
      <li class="nav"><a href="/projects">projects</a></li>
      <li class="nav"><a href="/about">about</a></li>
      <li class="nav"><a href="/feed.xml">feed</a></li>
    </ul>
  </section>
</nav>

    <div class="row">
      <section id="main" role="main" class="large-12 small-12 columns">
          <section id="blog" class="margin-bottom double">
    <article class="post margin-bottom double">
      <header class="page-header with-summary">
  <h1>
    When Your Fat Models Need to Go on a Diet, Part 2
  </h1>
    <h3>
      More thoughts on refactoring large model classes in Rails
    </h3>
</header>

        <figure>
          <img src="/assets/images/blog/stock/logs-pexels-photo-d2559811.jpg" alt="Logs pexels photo" />
        </figure>
      <p>In <a href="/when-your-fat-models-need-to-go-on-a-diet">part 1</a> of this post, I talked about using modules to help break source code of large models into smaller, comprehensible pieces. As <a href="http://blog.arielvalentin.com/" title="XP in Anger">Ariel Valentin</a> pointed out, we need to do more to lighten up the runtime memory footprint when large models are instantiated.</p>

<p>Let’s imagine we have an application with a <code>User</code> model (might not be a stretch) and we’re building a page that loads a bunch of user gravatars. Our <code>User</code> model has accumulated a ton of attributes, but we may only need a limited set to render the gravatar properly. We might add a line like this in the controller action to select only the needed attributes:</p>

<pre><code class="ruby">@users = User.select(%w[ id name gravatar\_id ]).all
</code></pre>

<p>Perhaps to make this more readable, we’ll extract our select statement into a scope in the <code>User</code> model:</p>

<pre><code class="ruby"># user.rb
scope :select\_gravatar\_attributes, select(%w[ id name gravatar\_id ])

# controller action
@users = User.select\_gravatar\_attributes.all
</code></pre>

<p>We’ll incur less memory overhead during this action at runtime since the app won’t have to load as much data. The caveat is that our <code>@users</code> won’t have access to the data we left behind, so we need to take care only to call methods that rely on the data we have actually loaded. It would be easier to test our lighter users if we could treat them as a different type.</p>

<p>Applying the model-slimming refactoring we discussed in <a href="/when-your-fat-models-need-to-go-on-a-diet/">part 1</a>, we can extract gravatar related functionality into a <code>UserExtensions::Gravatar</code> module and create a <code>Gravatar::User</code> that inherits from our <code>User</code> model. Furthermore, we can change our <code>select_gravatar_attributes</code> to a <code>default_scope</code> in the subclass, so whenever we grab <code>Gravatar::User</code> from the db, it’ll have only the attributes we need. Our controller action would now look like this:</p>

<pre><code class="ruby">@users = Gravatar::User.all
</code></pre>

<p>To put our savings to the test, we can run some basic benchmark tests. I created a sample rails 3.1 app and created ~2000 users records in my development database and ran the <code>rails benchmarker</code> script to load all users both normally and as gravatars. Here are the results:</p>

<p>All users</p>

<p><img src="/images/screenshots/user-perf-test.jpg" alt="All users" /></p>

<p>All as gravatars</p>

<p><img src="/images/screenshots/gravatar-user-perf-test.jpg" alt="All as gravatars" /></p>

<p>The memory footprint for gravatar users is half of that for our ‘fat’ users. Obviously results will vary greatly depending on architecture, application and the attributes selected, but this anecdotal case demonstrates potential for some big wins in instantiating slimmer subclasses of your heavy models.</p>

    </article>
    <section class="margin-bottom double">
      <a href="https://twitter.com/intent/tweet?text=When%20Your%20Fat%20Models%20Need%20to%20Go%20on%20a%20Diet%2C%20Part%202&amp;url=https%3A%2F%2Frossta.net%2Fblog%2Fwhen-your-fat-models-need-to-go-on-a-diet-part-2.html" class="button" target="_blank" rel="noopener">Share this post on Twitter</a>
    </section>
    <section class="signup-form-standalone margin-bottom quadruple">
      <!-- Begin MailChimp Signup Form -->
<div class="signup-form">
  <h3>Did you like this post?</h3>
  <p>Stay in the LOOP! Leave your email and I'll send you an occasional email on Ruby, Javascript, or Elixir for the web.</p>
  <div id="mc_embed_signup">
    <form action="//rossta.us6.list-manage.com/subscribe/post?id=96030b0bda&u=8ce159842b5c98cecb4ebdf16" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">

        <div class="row">
          <div class="large-10 columns">
            <div class="row collapse">
              <div class="large-8 small-7 columns">
                <input type="email" placeholder="Your email..." value="" name="EMAIL" class="required email" id="mce-EMAIL">
              </div>
              <div class="large-4 small-5 columns">
                <input type="submit" value="Sign me up!" name="subscribe" id="mc-embedded-subscribe" class="button postfix">
              </div>
            </div>
          </div>
        </div>

        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;"><input type="text" name="b_8ce159842b5c98cecb4ebdf16_96030b0bda" tabindex="-1" value=""></div>
      </div>

      <input type="hidden" name="SIGNUP" value="https://rossta.net/blog/2011-10-03-when-your-fat-models-need-to-go-on-a-diet-part-2.html" />
      <input type="hidden" name="SIGNUP_APP" value="Mailchimp" />
      <input type="hidden" name="SIGNUP_LOCATION" id="signup_location" value="blog/2011-10-03-when-your-fat-models-need-to-go-on-a-diet-part-2.html" />
      <input type="hidden" name="SIGNUP_TAGS" id="signup_tags" value="Ruby,Rails" />
    </form>
  </div>
  <!--End mc_embed_signup-->
</div>

    </section>
    <section class="margin-bottom double">
      <p>
        Published on Oct  3, 2011
      </p>
    </section>
  </section>
    <hr />
    <section class="comments">
      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname  = "rosskaff";
    var disqus_identifier = "when-your-fat-models-need-to-go-on-a-diet-part-2";
    var disqus_title      = "When Your Fat Models Need to Go on a Diet, Part 2";
    var disqus_url        = "https://rossta.net/blog/when-your-fat-models-need-to-go-on-a-diet-part-2.html";

    var disqus_config = function () {
        this.page.url = disqus_url;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = disqus_identifier; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.title = disqus_title;
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//rosskaff.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<!-- <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->

    </section>

      </section>
    </div>
    
    <footer>
  <div class="row">
    <img src="/assets/images/turtle-logo-096698b6.svg" class="turtle" alt="Turtle logo" />
    <section class="large-6 columns">
      <h5>Most Popular</h5>
      <ul>
          <li><a href="/blog/web-push-notifications-from-rails.html">Sending Web Push Notifications from Rails</a></li>
          <li><a href="/blog/n+1-is-a-rails-feature.html">N+1 is a Rails feature</a></li>
          <li><a href="/blog/what-i-learned-about-hanami.html">What I learned building an app in Hanami</a></li>
          <li><a href="/blog/how-to-specify-local-ruby-gems-in-your-gemfile.html">How to specify local Ruby gems in your Gemfile</a></li>
          <li><a href="/blog/service-worker-on-rails.html">Service Worker on Rails</a></li>
      </ul>
    </section>
    <section class="large-3 columns">
      <h5>Categories</h5>
      <ul>
          <li><a href="/blog/tags/ruby.html">Ruby</a></li>
          <li><a href="/blog/tags/rails.html">Rails</a></li>
          <li><a href="/blog/tags/javascript.html">JavaScript</a></li>
          <li><a href="/blog/tags/service-worker.html">Service Worker</a></li>
          <li><a href="/blog/tags/rspec.html">RSpec</a></li>
      </ul>
    </section>
    <section class="large-3 columns">
      <h5>Contact</h5>
      <ul>
        <li><a href="mailto:ross@rossta.net" rel="me noopener">email</a></li>
        <li><a href="https://twitter.com/rossta" rel="me noopener">twitter</a></li>
        <li><a href="https://medium.com/@rossta" rel="me noopener">medium</a></li>
        <li><a href="https://github.com/rossta" rel="me noopener">github</a></li>
        <!-- <li><a href="https://stackoverflow.com/users/771838/rossta?tab=profile" rel="me">stackoverflow</a></li> -->
        <li><a href="https://www.linkedin.com/in/rosskaffenberger" rel="me noopener">linkedin</a></li>
      </ul>
    </section>
  </div>
  <p class="copyright small subtle center">
    © 2018 Ross Kaffenberger. All rights reserved.
  </p>
</footer>

    <script src="/assets/javascripts/runtime.bundle-a9c6ad20.js"></script><script src="/assets/javascripts/vendor.bundle-6abddb3e.js"></script><script src="/assets/javascripts/app.bundle-e087dca1.js"></script>
    
    <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
analytics.load("NdBtrprkAGAjQryMShljRdVf90saElAU");
analytics.page()
window.$.tracking.flush(analytics);
}}();
</script>

  </body>
</html>
