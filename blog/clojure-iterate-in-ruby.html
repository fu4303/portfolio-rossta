<!doctype html>
<html>
  <head>
    <title>Clojure's iterate in Ruby - rossta.net</title>
<meta name="description" content="Implementing the Clojure sequence functions, iterate, with Ruby's Enumerator to emulate sequences" />
<meta name="keywords" content="Ruby, Clojure" />
<meta name="site" content="rossta.net" />
<meta property="og:site_name" content="rossta.net" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="Ross Kaffenberger" />
<meta name="twitter:description" content="Implementing the Clojure sequence functions, iterate, with Ruby's Enumerator to emulate sequences" />
<meta name="twitter:image:src" content="https://rossta.net/assets/images/blog/stock/umbrellas-pexels-photo-963fb7db.jpg" />
<meta name="twitter:title" content="Clojure's iterate in Ruby" />
<meta property="og:description" content="Implementing the Clojure sequence functions, iterate, with Ruby's Enumerator to emulate sequences" />
<meta property="og:image" content="https://rossta.net/assets/images/blog/stock/umbrellas-pexels-photo-963fb7db.jpg" />
<meta property="og:title" content="Clojure's iterate in Ruby" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon"                      href="/apple-touch-icon.png" />
    <link rel="icon"                                  href="/touch-icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/touch-icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="144x144" href="/touch-icon-144x144.png" />
    <link rel="icon" type="image/png" sizes="96x96"   href="/touch-icon-96x96.png" />
    <link rel="icon" type="image/png" sizes="72x72"   href="/touch-icon-72x72.png" />
    <link rel="icon" type="image/png" sizes="32x32"   href="/touch-icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16"   href="/touch-icon-16x16.png">

    <link rel="mask-icon" href="/safari-pinned-tab-5cdca7ae.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    <link rel="pingback" href="https://webmention.io/rossta.net/xmlrpc" />
    <link rel="webmention" href="https://webmention.io/rossta.net/webmention" />

    <script type="text/javascript" src="//use.typekit.net/ned0mml.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <link href="/assets/stylesheets/app.bundle-3f3ff3db.css" rel="stylesheet" />
  </head>
  <body id="application" class="typekit">
    <nav id="welcome-nav" class="top-bar" data-topbar>
  <ul class="title-area">
    <li class="name">
      <h1><a class="logo" href="/"><img src="/assets/images/turtle-logo-096698b6.svg" alt="Turtle logo" /><span>rossta.net</span></a></h1>
    </li>
    <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
  </ul>

  <section class="top-bar-section">
    <ul class="left">
      <li class="nav"><a href="/blog">blog</a></li>
      <li class="nav"><a href="/series">series</a></li>
      <li class="nav"><a href="/talks">talks</a></li>
      <li class="nav"><a href="/projects">projects</a></li>
      <li class="nav"><a href="/about">about</a></li>
      <li class="nav"><a href="/feed.xml">feed</a></li>
    </ul>
  </section>
</nav>

    <div class="row">
      <section id="main" role="main" class="large-12 small-12 columns">
          <section id="blog" class="margin-bottom double">
    <article class="post margin-bottom double">
      <header class="page-header with-summary">
  <h1>
    Clojure's iterate in Ruby
  </h1>
    <h3>
      Using Ruby Enumerator to emulate sequences
    </h3>
</header>


      <p>In functional languages, the key building blocks are functions and data. Clojure has a particularly interesting data structure, <a href="http://clojure.org/sequences">sequences</a>, not featured in the Ruby standard library. A Clojure sequence is an immutable collection that representing the result of an algorithm. Previously, I described how to generate Clojure-like <a href="https://rossta.net/blog/pascals-triangle-with-rubys-enumerator.html">sequences in Ruby</a> (without the immutability anyways), including <a href="https://rossta.net/blog/infinite-sequences-in-ruby.html">Pascal&#39;s Triangle</a> using <code>Enumerator</code>, which allows us to package up an algorithm as an object that can emit values as any &quot;eager&quot; collection can, like <code>Array</code> and <code>Hash</code>.</p>

<p>Clojure provides a few functions that can be used to generate sequences,
including <code>iterate</code>. According to the <a href="https://clojuredocs.org/clojure.core/iterate">docs</a>,</p>

<blockquote>
<p><code>Returns a lazy sequence of x, (f x), (f (f x)) etc. f must be free of side-effects</code></p>
</blockquote>

<p>In other words, <code>iterate</code> will emit values starting with the first and repeatedly call the given function with the return value of the previous call.</p>

<p>The signature in Clojure looks this:</p>

<pre><code class="clojure">(iterate f x)
</code></pre>

<p>So, we can generate a simple sequence of numbers using the <code>inc</code> function and some start value:</p>

<pre><code class="clojure">=&gt; (iterate inc 1)
(1 2 3 4 5 ...)
</code></pre>

<p>Of course, we have a terse was of generating a sequence like this in Ruby:</p>

<pre><code class="ruby">irb(main)&gt; (1..5).to_a
=&gt; [1, 2, 3, 4, 5]
</code></pre>

<p>But this solution doesn&#39;t generalize to other types of sequences like, for instance,
generating a sequence of the powers of 2. In the example below, <code>(partial * 2)</code>
returns a function that multiplies a single argument by 2.</p>

<pre><code class="clojure">=&gt; (iterate (partial * 2) 1)
(1 2 4 8 16 32 64 128 ...)
</code></pre>

<p>To get this result in Ruby, we might try something like:</p>

<pre><code class="ruby">irb&gt; (1..7).each_with_object([]) { |n, seq| seq &lt;&lt; (seq.last.nil? ? n : seq.last * 2) }
=&gt; [1, 2, 4, 8, 16, 32, 64]
</code></pre>

<p>Not very pretty (ok, I admit that&#39;s a strawman). But this also is an &quot;eagerly&quot;
generated collection whereas we want something that can be lazily generated to
get closer to Clojure.</p>

<p>While there may be a number of ways to generate these sequences in Ruby, for this
exercise, we also want something that has a similar signature to Clojure&#39;s <code>iterate</code>,
like this:</p>

<pre><code class="ruby">iterate(x, &amp;block)
</code></pre>

<p>We&#39;ll leverage Ruby&#39;s method block convention in place of the function, <code>f</code>.
Usage:</p>

<pre><code class="ruby">irb&gt; iterate(1) { |n| n + 1 }
=&gt; [1, 2, 3, 4, 5, ...]
irb&gt; iterate(1) { |n| n * 2 }
=&gt; [1, 2, 4, 8, 16, 32, 64, ...]
</code></pre>

<p>The two examples now have the same &quot;surface area&quot; and have a lot in common with the Clojure
companions. So how would we implement this?</p>

<p>First a test. By the way, all the code found in the following examples is <a href="https://github.com/rossta/loves-enumerable/tree/master/examples/sequence">on Github</a>.</p>

<pre><code class="ruby">require &#39;minitest/autorun&#39;
require_relative &#39;./sequence&#39;

class TestSequence &lt; Minitest::Test
  include Sequence

  def test_iterate_increment
    sequence = iterate(1) { |x| x + 1 }

    assert_equal sequence.first(5), [1, 2, 3, 4, 5]
  end

  def test_iterate_power_of_2
    sequence = iterate(1) { |x| x * 2 }

    assert_equal sequence.first(5), [1, 2, 4, 8, 16]
  end
end
</code></pre>

<p>We&#39;re going to implement <code>iterate</code> in a Ruby module called <code>Sequence</code>. Our test
for <code>iterate</code> will return an instance of <code>Enumerator</code> (the <code>sequence</code> variable).
The enumerator allows use to generate the sequence on demand with the call to
<code>#first</code>.</p>

<p>Here&#39;s the implementation:</p>

<pre><code class="ruby">module Sequence
  def iterate(arg)
    Enumerator.new do |yielder|
      current = arg
      loop do
        yielder &lt;&lt; current
        current = yield(current)
      end
    end
  end
end
</code></pre>

<p>Our implementation of <code>iterate</code> returns an <code>Enumerator</code> that will first yield
the given <code>arg</code> and repeatedly call the given block with the result of the
previous call. The <code>loop</code> construct means this enumeration can potentially
continue forever - capturing the spirit of a Clojure sequence. That means
we need to use a terminating functions like <code>#first</code> or <code>#take</code> to limit the
results, just like we would in Clojure:</p>

<pre><code class="clojure">=&gt; (take 5 (iterate (partial * 2) 1))
(1 2 4 8 16)
</code></pre>

<p>The Ruby equivalent:</p>

<pre><code class="ruby">iterate(1) { |n| n * 2 }.take(5)
=&gt; [1, 2, 4, 8, 16]
</code></pre>

<p>We could go one step further an make this method work as a mixin. Below is a
test for using <code>iterate</code> as an instance method of a class using in our tests
that will simply delegate missing methods to the object passed in on
instantiation.</p>

<pre><code class="ruby">class TestSequence &lt; Minitest::Test
  include Sequence

  class Sequenced &lt; SimpleDelegator
    include Sequence
  end

  def test_iterate_include
    num = Sequenced.new(0)

    sequence = num.iterate { |x| x - 1 }
    assert_equal sequence.first(5), [0, -1, -2, -3, -4]
  end
end
</code></pre>

<p>To make this pass, we need only set the default arg to <code>self</code>:</p>

<pre><code class="ruby">module Sequence
  def iterate(arg = self)
    # ...
  end
end
</code></pre>

<p>So what? Ok, well, you may be hard pressed to use <code>iterate</code> in your daily work,
but there is certainly more room to think about data processing as functional
operations (free of side effects) on sequences (values that can be generated on demand). Something like <code>iterate</code> need not apply to only numbers; you can imagine sequences of letters, time objects, or POROs also being generated. At times, Rubyist are too quick to wrap collections in other classes when simpler, more generalizable &quot;functional&quot; transforms could suffice.</p>

<p>When I started <a href="http://devpost.com/software/learning-clojure">learning Clojure</a> last year, I got really excited about the functional aspects of Ruby. &quot;Wait, I thought everything in Ruby is an object.&quot; Yes, but a great thing about Ruby is its <a href="http://yehudakatz.com/2009/07/11/python-decorators-in-ruby/">ability to adopt aspects of other languages</a>. As Piotr Solnica illustrates in <a href="https://speakerdeck.com/solnic/blending-functional-and-oo-programming-in-ruby">his recent talk</a>, blending functional techniques with our OO code can have a lot of benefits including avoidance of side effects and favoring composability. Introducing sequence-generating methods, like we saw here, is just one small idea to help sprinkle a little functional flavor into your Ruby code.</p>

    </article>
    <section class="margin-bottom double">
      <a href="https://twitter.com/intent/tweet?text=Clojure%27s%20iterate%20in%20Ruby&amp;url=https%3A%2F%2Frossta.net%2Fblog%2Fclojure-iterate-in-ruby.html" class="button" target="_blank" rel="noopener">Share this post on Twitter</a>
    </section>
    <section class="signup-form-standalone margin-bottom quadruple">
      <!-- Begin MailChimp Signup Form -->
<div class="signup-form">
  <h3>Did you like this post?</h3>
  <p>Stay in the LOOP! Leave your email and I'll send you an occasional email on Ruby, Javascript, or Elixir for the web.</p>
  <div id="mc_embed_signup">
    <form action="//rossta.us6.list-manage.com/subscribe/post?id=96030b0bda&u=8ce159842b5c98cecb4ebdf16" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">

        <div class="row">
          <div class="large-10 columns">
            <div class="row collapse">
              <div class="large-8 small-7 columns">
                <input type="email" placeholder="Your email..." value="" name="EMAIL" class="required email" id="mce-EMAIL">
              </div>
              <div class="large-4 small-5 columns">
                <input type="submit" value="Sign me up!" name="subscribe" id="mc-embedded-subscribe" class="button postfix">
              </div>
            </div>
          </div>
        </div>

        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;"><input type="text" name="b_8ce159842b5c98cecb4ebdf16_96030b0bda" tabindex="-1" value=""></div>
      </div>

      <input type="hidden" name="SIGNUP" value="https://rossta.net/blog/2016-02-17-clojure-iterate-in-ruby.html" />
      <input type="hidden" name="SIGNUP_APP" value="Mailchimp" />
      <input type="hidden" name="SIGNUP_LOCATION" id="signup_location" value="blog/2016-02-17-clojure-iterate-in-ruby.html" />
        <input type="hidden" name="group[17961][1]" id="signup_technology" value="Ruby" />
        <input type="hidden" name="group[17961][2]" id="signup_technology" value="Clojure" />
    </form>
  </div>
  <!--End mc_embed_signup-->
</div>

    </section>
    <article>
        <figure>
          <img src="/assets/images/blog/stock/umbrellas-pexels-photo-963fb7db.jpg" alt="Umbrellas pexels photo" />
        </figure>
    </article>
    <section class="margin-bottom double">
      <p>
          Part of the <a href="/blog/series/enumerable.html">Enumerable</a> series.
        Published on Feb 17, 2016
      </p>
    </section>
  </section>
    <hr />
    <section class="comments">
      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname  = "rosskaff";
    var disqus_identifier = "clojure-iterate-in-ruby";
    var disqus_title      = "Clojure's iterate in Ruby";
    var disqus_url        = "https://rossta.net/blog/clojure-iterate-in-ruby.html";

    var disqus_config = function () {
        this.page.url = disqus_url;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = disqus_identifier; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.title = disqus_title;
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//rosskaff.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<!-- <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->

    </section>

      </section>
    </div>
    
    <footer>
  <div class="row">
    <img src="/assets/images/turtle-logo-096698b6.svg" class="turtle" alt="Turtle logo" />
    <section class="large-6 columns">
      <h5>Most Popular</h5>
      <ul>
          <li><a href="/blog/web-push-notifications-from-rails.html">Sending Web Push Notifications from Rails</a></li>
          <li><a href="/blog/n-1-is-a-rails-feature.html">N+1 is a Rails feature</a></li>
          <li><a href="/blog/what-i-learned-about-hanami.html">What I learned building an app in Hanami</a></li>
          <li><a href="/blog/how-to-specify-local-ruby-gems-in-your-gemfile.html">How to specify local Ruby gems in your Gemfile</a></li>
          <li><a href="/blog/service-worker-on-rails.html">Service Worker on Rails</a></li>
      </ul>
    </section>
    <section class="large-3 columns">
      <h5>Categories</h5>
      <ul>
          <li><a href="/blog/tags/ruby.html">Ruby</a></li>
          <li><a href="/blog/tags/rails.html">Rails</a></li>
          <li><a href="/blog/tags/javascript.html">JavaScript</a></li>
          <li><a href="/blog/tags/vue.html">Vue</a></li>
          <li><a href="/blog/tags/service-worker.html">Service Worker</a></li>
      </ul>
    </section>
    <section class="large-3 columns">
      <h5>Contact</h5>
      <ul>
        <li><a href="mailto:ross@rossta.net" rel="me noopener">email</a></li>
        <li><a href="https://twitter.com/rossta" rel="me noopener">twitter</a></li>
        <li><a href="https://medium.com/@rossta" rel="me noopener">medium</a></li>
        <li><a href="https://github.com/rossta" rel="me noopener">github</a></li>
        <!-- <li><a href="https://stackoverflow.com/users/771838/rossta?tab=profile" rel="me">stackoverflow</a></li> -->
        <li><a href="https://www.linkedin.com/in/rosskaffenberger" rel="me noopener">linkedin</a></li>
      </ul>
    </section>
  </div>
  <p class="copyright small subtle center">
    © 2018 Ross Kaffenberger. All rights reserved.
  </p>
</footer>

    <script src="/assets/javascripts/runtime.bundle-2352c808.js"></script><script src="/assets/javascripts/vendor.bundle-0116f3b0.js"></script><script src="/assets/javascripts/app.bundle-ed1e4144.js"></script>
    
    <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
analytics.load("NdBtrprkAGAjQryMShljRdVf90saElAU");
analytics.page()
window.$.tracking.flush(analytics);
}}();
</script>

  </body>
</html>
