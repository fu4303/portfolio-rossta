<!doctype html>
<html class="antialiased">
  <head>
    <title>Debugging SystemStackError - rossta.net</title>
<meta name="description" content="Prior to Ruby 2.2, debugging stack overflow errors can be painful because most of the backtrace is swallowed in the output. Learn a quick workaround with Kernel.set_trace_func." />
<meta name="keywords" content="Ruby" />
<meta name="site" content="rossta.net" />
<meta property="og:site_name" content="rossta.net" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="Ross Kaffenberger" />
<meta name="twitter:description" content="Prior to Ruby 2.2, debugging stack overflow errors can be painful because most of the backtrace is swallowed in the output. Learn a quick workaround with Kernel.set_trace_func." />
<meta name="twitter:image:src" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo.jpg" />
<meta name="twitter:title" content="Debugging SystemStackError" />
<meta property="og:description" content="Prior to Ruby 2.2, debugging stack overflow errors can be painful because most of the backtrace is swallowed in the output. Learn a quick workaround with Kernel.set_trace_func." />
<meta property="og:image" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo.jpg" />
<meta property="og:title" content="Debugging SystemStackError" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="pingback" href="https://webmention.io/rossta.net/xmlrpc" />
    <link rel="webmention" href="https://webmention.io/rossta.net/webmention" />

    <link href='/assets/css/app.chunk.b98d856c2fc05a39cdaf.css' rel='stylesheet'></link>
  </head>
  <body id="application" class="leading-normal text-gray-900">
    <header id="welcome-nav" class="top-bar text-gray-800 sm:flex sm:justify-between sm:items-center sm:px-4 sm:py-3" data-topbar>
  <div class="flex justify-between items-center px-4 py-3 sm:p-0">
    <h1 class="text-2xl font-bold">
      <a class="logo" href="/"><span>rossta.net</span></a>
    </h1>
    <button type="button" class="top-bar-menu-button sm:hidden block text-gray-500 hover:text-gray-700 focus:text-gray-700 focus:outline-none">
      <svg class="h-6 w-6 fill-current" viewBox="0 0 24 24">
        <path class="icon" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
        <path class="icon hidden" d="M18.278 16.864a1 1 0 0 1-1.414 1.414l-4.829-4.828-4.828 4.828a1 1 0 0 1-1.414-1.414l4.828-4.829-4.828-4.828a1 1 0 0 1 1.414-1.414l4.829 4.828 4.828-4.828a1 1 0 1 1 1.414 1.414l-4.828 4.829 4.828 4.828z"/>
      </svg>
    </button>
  </div>

  <nav class="top-bar-section hidden sm:block sm:flex sm:justify-around px-2 pt-2 pb-4">
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2" href="/blog">blog</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/series">series</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/talks">talks</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/projects">projects</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/about">about</a>
    <a class="block px-2 py-1 hover:bg-green-200 sm:mt-0 sm:ml-2 mt-1" href="/feed.xml">feed</a>
  </nav>
</header>

    <main id="main" role="main" class="layout container">
        <article class="post mb-12">
    <header class="page-header mt-4">
  <h1>
    Debugging SystemStackError
  </h1>
    <h2 class="mt-4 text-gray-600 font-medium">
      Use Kernel tracing to inspect method Ruby method calls
    </h2>
</header>

    <p>Arrgggh. Ever come across this in your Ruby app?</p>

<pre><code class="bash">SystemStackError: stack level too deep
    /Users/ross/dev/rossta/montrose/lib/montrose/options.rb:204
</code></pre>

<p>A <code>SystemStackError</code> occurs when your Ruby code encounters a stack overflow; in
other words, the memory allocated to execute the program exceeded the memory
available on the stack.</p>

<p>The most common cause of a stack overflow in application code that
recursively calls itself without terminating arguments: an infinite loop in your
code.</p>

<p>You can reproduce such an error with code like this in a terminal:</p>

<pre><code class="bash">$ pry --noprompt
def foo
  foo
end
=&gt; :foo
foo
SystemStackError: stack level too deep
from /Users/ross/.gem/ruby/2.1.6/gems/pry-0.10.3/lib/pry/pry_instance.rb:355
</code></pre>

<p>Note: for the examples in this post, assume I&#39;m using Ruby 2.1 unless otherwise
indicated.</p>

<pre><code class="json">$ ruby -v
ruby 2.1.6p336 (2015-04-13 revision 50298) [x86_64-darwin14.0]
</code></pre>

<p>Prior to Ruby 2.2 and <a href="https://bugs.ruby-lang.org/issues/6216">this issue</a>, the
backtrace for <code>SystemStackError</code> was reduced to one line. That meant, unless
that one line lead you to an obvious culprit in your source code, it
would be very difficult to unravel the method calls causing the stack to overflow.</p>

<p>So, first step in debugging the <code>SystemStackError</code> is upgrade to Ruby 2.2!</p>

<p>In case that&#39;s not possible, there&#39;s still hope. Let&#39;s try using information
from the error first. Here&#39;s the method containing <a href="https://github.com/rossta/montrose/blob/e5b7a12f6832b4f971a52b27800cefe144ecd399/lib/montrose/options.rb#L204">the line in the backtrace</a>:</p>

<pre><code class="ruby"># lib/montrose/options.rb:204

def map_arg(arg, &amp;block)
  return nil unless arg

  Array(arg).map(&amp;block)    # line 204
end
</code></pre>

<p>No obvious culprit. This method doesn&#39;t call itself and there are multiple callers
of this method in this class.</p>

<p>Let&#39;s try rescuing from the error in a test and printing the execution stack
using <a href="http://ruby-doc.org/core-2.2.3/Kernel.html#method-i-caller"><code>Kernel.caller</code></a>. I can isolate the application code that produces the stack overflow in a single test and rescue there.</p>

<pre><code class="ruby">it &quot;a test&quot; do
  # given

  begin
    # when
  rescue SystemStackError
    puts caller
  end

  # then
end
</code></pre>

<p>Here&#39;s what I get:</p>

<pre><code class="bash">$ bin/m spec/rfc_spec.rb:426
/Users/ross/dev/rossta/montrose/spec/rfc_spec.rb:434:in `block (2 levels) in &lt;top (required)&gt;&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:108:in `block (3 levels) in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:205:in `capture_exceptions&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:105:in `block (2 levels) in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:256:in `time_it&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:104:in `block in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:334:in `on_signal&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:276:in `with_info_handler&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:103:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:781:in `run_one_method&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:308:in `run_one_method&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:296:in `block (2 levels) in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:295:in `each&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:295:in `block in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:334:in `on_signal&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:321:in `with_info_handler&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:294:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:155:in `block in __run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:155:in `map&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:155:in `__run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:129:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/lib/m/runners/minitest_5.rb:9:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/lib/m/executor.rb:26:in `execute&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/lib/m/runner.rb:17:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/lib/m.rb:13:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/bin/m:4:in `&lt;top (required)&gt;&#39;
bin/m:16:in `load&#39;
bin/m:16:in `&lt;main&gt;&#39;
</code></pre>

<p>The backtrace points to lines in minitest. Since I&#39;ve been running tests prior
to this isssue successfully, it&#39;s unlikely minitest is the source of the stack overflow error. So rescuing from <code>SytemStackError</code> doesn&#39;t help us either.</p>

<p>Luckily, we have <a href="https://gist.github.com/jbgo/4493822">this gist</a> from
<a href="https://github.com/jbgo">@jbgo</a> who highlighted a special feature in Ruby for
tracing function events: <a href="http://ruby-doc.org/core-1.9.3/Kernel.html#method-i-set_trace_func"><code>Kernel.set_trace_func</code></a>.</p>

<p>Here&#39;s the example from the docs:</p>

<pre><code class="ruby">class Test
  def test
    a = 1
    b = 2
  end
end

set_trace_func proc { |event, file, line, id, binding, classname|
  printf &quot;%8s %s:%-2d %10s %8s\n&quot;, event, file, line, id, classname
}
t = Test.new
t.test

    line prog.rb:11               false
  c-call prog.rb:11        new    Class
  c-call prog.rb:11 initialize   Object
c-return prog.rb:11 initialize   Object
c-return prog.rb:11        new    Class
    line prog.rb:12               false
    call prog.rb:2        test     Test
    line prog.rb:3        test     Test
    line prog.rb:4        test     Test
  return prog.rb:4        test     Test
</code></pre>

<p>The method <code>set_trace_func</code> sets a global proc to be invoked in response to
runtime events including the following:</p>

<ul>
<li><code>c-call</code> a C-language routine</li>
<li><code>c-return</code> return from a C-language routine</li>
<li><code>call</code> a Ruby method</li>
<li><code>class</code> start a class or module definition</li>
<li><code>end</code> finish a class or module definition</li>
<li><code>line</code> execute code on a new line</li>
<li><code>raise</code> raise an exception</li>
<li><code>return</code> return from a Ruby method</li>
</ul>

<p>Since we want to isolate the Ruby method causing the infinite loop in our stack,
we&#39;ll log the line info for <code>call</code> events:</p>

<pre><code class="ruby"># spec/spec_helper.rb

$trace_out = open(&quot;trace.txt&quot;)

set_trace_func proc { |event, file, line, id, binding, classname|
  if event == &#39;call&#39;
    $trace_out.puts &quot;#{file}:#{line} #{classname}##{id}&quot;
  end
}
</code></pre>

<p>Re-running the test produces a <code>trace.txt</code> file that records all the Ruby method
calls encountered during execution. Inspecting this log, we hope to find a
repeating pattern of an identical list of method calls.</p>

<p>In my case, the start of each pattern pointed to another line in my source where
the stack originates:</p>

<pre><code>/Users/ross/dev/rossta/montrose/lib/montrose/stack.rb:38 Montrose::Stack#advance
/Users/ross/dev/rossta/montrose/lib/montrose/frequency/yearly.rb:4 Montrose::Frequency::Yearly#include?
/Users/ross/dev/rossta/montrose/lib/montrose/frequency.rb:51 Montrose::Frequency#matches_interval?
...
/Users/ross/dev/rossta/montrose/lib/montrose/stack.rb:38 Montrose::Stack#advance
/Users/ross/dev/rossta/montrose/lib/montrose/frequency/yearly.rb:4 Montrose::Frequency::Yearly#include?
/Users/ross/dev/rossta/montrose/lib/montrose/frequency.rb:51 Montrose::Frequency#matches_interval?
...
/Users/ross/dev/rossta/montrose/lib/montrose/stack.rb:38 Montrose::Stack#advance
/Users/ross/dev/rossta/montrose/lib/montrose/frequency/yearly.rb:4 Montrose::Frequency::Yearly#include?
/Users/ross/dev/rossta/montrose/lib/montrose/frequency.rb:51 Montrose::Frequency#matches_interval?
...
</code></pre>

<p>A useful trick is to keep the trace routine in a separate file that you can
incorporate with an environment variable. You can also leverage <code>Kernel.caller</code>
here and only log when the stack exceeds an arbitrarily large size.</p>

<pre><code class="ruby"># spec/support/trace.rb

if ENV[&quot;TRACE&quot;]
  $stack_size = ENV[&quot;TRACE&quot;].to_i
  $trace_out = open(&quot;trace.txt&quot;)

  set_trace_func proc { |event, file, line, id, binding, classname|
    if event == &#39;call&#39; &amp;&amp; caller.length &gt; $stack_size
      $trace_out.puts &quot;#{file}:#{line} #{classname}##{id}&quot;
    end
  }
end
</code></pre>

<p>In my <a href="https://github.com/rossta/montrose">Montrose</a> gem, <a href="https://github.com/rossta/montrose/blob/9600e0b63bde342011b3b9b1e29ab9f76f5f69c3/spec/support/trace.rb">this file</a> gets loaded during every test run but the <code>set_trace_func</code> hook will
only be evaluated when the <code>TRACE</code> environment variable is present:</p>

<pre><code>$ TRACE=500 bin/m spec/montrose/recurrence_spec.rb
</code></pre>

<p>Again, you won&#39;t need to resort to this workaround for <code>SystemStackError</code> in Ruby
2.2+, but keep this in mind next time you get stuck &quot;in the loop&quot;.</p>

  </article>
  <section class="signup-form-standalone hero">
    <script src="https://f.convertkit.com/ckjs/ck.5.js" async></script>
<form
  action="https://app.convertkit.com/forms/818387/subscriptions?ref=Ruby"
  class="seva-form formkit-form"
  method="post"
  data-sv-form="818387"
  data-uid="cda82aafbf"
  data-format="inline"
  data-version="5"
  data-options="{&quot;settings&quot;:{&quot;after_subscribe&quot;:{&quot;action&quot;:&quot;message&quot;,&quot;success_message&quot;:&quot;Success! Now check your email to confirm your subscription.&quot;,&quot;redirect_url&quot;:&quot;&quot;},&quot;modal&quot;:{&quot;trigger&quot;:&quot;timer&quot;,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:&quot;300&quot;,&quot;devices&quot;:null,&quot;show_once_every&quot;:&quot;7&quot;},&quot;recaptcha&quot;:{&quot;enabled&quot;:false},&quot;return_visitor&quot;:{&quot;action&quot;:&quot;show&quot;,&quot;custom_content&quot;:&quot;&quot;},&quot;slide_in&quot;:{&quot;display_in&quot;:null,&quot;trigger&quot;:null,&quot;scroll_percentage&quot;:null,&quot;timer&quot;:null,&quot;devices&quot;:null,&quot;show_once_every&quot;:null}}}"
>
  <div>
    <div class="mb-4">
        <h3 class="mb-2">
  Did you like this post?
</h3>
<p>
  Please
  <a href="https://twitter.com/intent/tweet?text=Debugging%20SystemStackError&amp;url=https%3A%2F%2Frossta.net%2Fblog%2Fdebugging-systemstackerror.html" target="_blank" rel="noopener">share it on Twitter</a>
  and enter your email below to subscribe to my newsletter on
  Ruby and the web. Thank you!
</p>

    </div>
    <ul class="formkit-alert formkit-alert-error" data-element="errors" data-group="alert"></ul>
    <div data-element="fields" data-stacked="false" class="seva-fields formkit-fields">
      <div class="formkit-field">
        <input
          class="formkit-input"
          name="email_address"
          placeholder="Your email address"
          required=""
          type="text"
          style="border-color: rgb(227, 227, 227); border-radius: 4px; color: rgb(0, 0, 0); font-weight: 400;"
        />
      </div>
      <button
        data-element="submit"
        class="formkit-submit button button-green"
      >
        <div class="formkit-spinner">
          <div></div>
          <div></div>
          <div></div>
        </div>
        <span>Subscribe</span>
      </button>
    </div>
    <a
      href="https://convertkit.com/?utm_source=dynamic&amp;utm_medium=referral&amp;utm_campaign=poweredby&amp;utm_content=form"
      class="formkit-powered-by"
      data-element="powered-by"
      target="_blank"
      rel="noopener noreferrer"
      >Powered By ConvertKit</a
    >
  </div>
  <style>
  </style>
    <input type="hidden" name="tags[]" value="733960" />
  <input type="hidden" aria-label="URL" name="fields[url]" placeholder="URL" value="https://rossta.net/blog/2016-01-12-debugging-systemstackerror.html" />
</form>


  </section>
  <article class="mb-12">
      <figure>
        <img src="/assets/images/blog/stock/logs-pexels-photo.jpg" alt="Logs pexels photo" />
      </figure>
  </article>
  <section class="mb-12 italic font-light">
    <p>
      Published on Jan 12, 2016
    </p>
  </section>

    </main>
    
    <footer class="bg-silver border-t text-xs">
  <div class="layout container p-6">
    <img src="/assets/images/turtle-logo.svg" class="turtle w-8 mb-6" alt="Turtle logo" />
    <section class="lg:flex lg:justify-between">
      <section class="mb-8">
        <h5 class="font-bold mb-4">Most Popular</h5>
        <ul>
            <li class="mb-1"><a href="/blog/building-a-pdf-viewer-with-vue-part-1.html">Rendering PDF pages with PDF.js and Vue</a></li>
            <li class="mb-1"><a href="/blog/from-sprockets-to-webpack.html">How we switched from Sprockets to Webpack</a></li>
            <li class="mb-1"><a href="/blog/how-to-specify-local-ruby-gems-in-your-gemfile.html">How to specify local Ruby gems in your Gemfile</a></li>
            <li class="mb-1"><a href="/blog/local-ssl-for-rails-5.html">Local SSL for Rails 5 development and tests</a></li>
            <li class="mb-1"><a href="/blog/using-the-web-push-api-with-vapid.html">Using Web Push Notifications with VAPID</a></li>
        </ul>
      </section>
      <section class="mb-8">
        <h5 class="font-bold mb-4">
          <a class="text-gray-900 hover:text-gray-700" href="blog/tags.html">
            Categories
          </a>
        </h5>
        <ul>
            <li class="mb-1"><a href="/blog/tags/ruby.html">Ruby</a></li>
            <li class="mb-1"><a href="/blog/tags/rails.html">Rails</a></li>
            <li class="mb-1"><a href="/blog/tags/javascript.html">JavaScript</a></li>
            <li class="mb-1"><a href="/blog/tags/vue.html">Vue</a></li>
            <li class="mb-1"><a href="/blog/tags/webpack.html">Webpack</a></li>
        </ul>
      </section>
      <section class="mb-8">
        <h5 class="font-bold mb-4">Contact</h5>
        <ul>
          <li class="mb-1"><a href="mailto:ross@rossta.net" rel="me noopener">email</a></li>
          <li class="mb-1"><a href="https://twitter.com/rossta" rel="me noopener">twitter</a></li>
          <li class="mb-1"><a href="https://medium.com/@rossta" rel="me noopener">medium</a></li>
          <li class="mb-1"><a href="https://github.com/rossta" rel="me noopener">github</a></li>
          <!-- <li class="mb-1"><a href="https://stackoverflow.com/users/771838/rossta?tab=profile" rel="me">stackoverflow</a></li> -->
          <li class="mb-1"><a href="https://www.linkedin.com/in/rosskaffenberger" rel="me noopener">linkedin</a></li>
        </ul>
      </section>
    </section>
    <p class="copyright text-center text-xs font-light">
      © 2019 Ross Kaffenberger. All rights reserved.
    </p>
  </div>
</footer>

    <script src='/assets/js/runtime.a975f6583411ef9e4ea1.js'></script><script src='/assets/js/vendors~app.chunk.6c6b7f30d28c87e9d1b2.js'></script><script src='/assets/js/app.chunk.40bf88435cbef0a86cb4.js'></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-16458563-2"></script>
<script type="text/javascript">
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-16458563-2');
</script>

  </body>
</html>
