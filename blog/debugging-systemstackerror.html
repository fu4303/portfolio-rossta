<!doctype html>
<html>
  <head>
    <title>Debugging SystemStackError - rossta.net</title>
<meta name="description" content="Prior to Ruby 2.2, debugging stack overflow errors can be painful because most of the backtrace is swallowed in the output. Learn a quick workaround with Kernel.set_trace_func." />
<meta name="keywords" content="Ruby" />
<meta name="site" content="rossta.net" />
<meta property="og:site_name" content="rossta.net" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:creator" content="Ross Kaffenberger" />
<meta name="twitter:description" content="Prior to Ruby 2.2, debugging stack overflow errors can be painful because most of the backtrace is swallowed in the output. Learn a quick workaround with Kernel.set_trace_func." />
<meta name="twitter:image:src" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo-d2559811.jpg" />
<meta name="twitter:title" content="Debugging SystemStackError" />
<meta property="og:description" content="Prior to Ruby 2.2, debugging stack overflow errors can be painful because most of the backtrace is swallowed in the output. Learn a quick workaround with Kernel.set_trace_func." />
<meta property="og:image" content="https://rossta.net/assets/images/blog/stock/logs-pexels-photo-d2559811.jpg" />
<meta property="og:title" content="Debugging SystemStackError" />
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon"                 href="/apple-touch-icon.png" />
    <link rel="icon"             sizes="192x192" href="/touch-icon-192x192.png" />
    <link rel="icon"             sizes="36x36"   href="/touch-icon-36x36.png" />
    <link rel="icon"             sizes="48x48"   href="/touch-icon-48x48.png" />
    <link rel="icon"             sizes="72x72"   href="/touch-icon-72x72.png" />
    <link rel="icon"             sizes="96x96"   href="/touch-icon-96x96.png" />
    <link rel="icon"             sizes="144x144" href="/touch-icon-144x144.png" />
    <link rel="icon"                             href="/touch-icon-192x192.png" />

    <script type="text/javascript" src="//use.typekit.net/ned0mml.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <link href="/assets/stylesheets/index.bundle-b473780b.css" rel="stylesheet" />
    <script src="/assets/javascripts/head.bundle-a0229364.js"></script>
    <link href="/assets/images/turtle-favicon.ico" rel="icon" type="image/ico" />
    <script src="//load.sumome.com/" data-sumo-site-id="4e5296d0b3f078761e3d795e6e9b33b6d80a1a1de31de31018515c9916e38ad7" async="async"></script>

  </head>
  <body id="application" class="typekit">
    <nav id="welcome-nav" class="top-bar" data-topbar>
  <ul class="title-area">
    <li class="name">
      <h1><a class="logo" href="/"><img src="/assets/images/turtle-logo-096698b6.svg" /><span>rossta.net</span></a></h1>
    </li>
    <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
  </ul>

  <section class="top-bar-section">
    <ul class="left">
      <li class="nav"><a href="/blog">blog</a></li>
      <li class="nav"><a href="/talks">talks</a></li>
      <li class="nav"><a href="/projects">projects</a></li>
      <li class="nav"><a href="/about">about</a></li>
      <li class="nav"><a href="/feed.xml">feed</a></li>
    </ul>
  </section>
</nav>

    <div class="row">
      <section id="main" role="main" class="large-12 small-12 columns">
          <section id="blog" class="margin-bottom double">
    <article class="post margin-bottom double">
      <header class="page-header with-summary">
  <h1>
    Debugging SystemStackError
  </h1>
    <h3>
      Use Kernel tracing to inspect method Ruby method calls
    </h3>
</header>

        <p><img src="/assets/images/blog/stock/logs-pexels-photo-d2559811.jpg" /></p>

      <p>Arrgggh. Ever come across this in your Ruby app?</p>

<pre><code class="bash">SystemStackError: stack level too deep
    /Users/ross/dev/rossta/montrose/lib/montrose/options.rb:204
</code></pre>

<p>A <code>SystemStackError</code> occurs when your Ruby code encounters a stack overflow; in
other words, the memory allocated to execute the program exceeded the memory
available on the stack.</p>

<p>The most common cause of a stack overflow in application code that
recursively calls itself without terminating arguments: an infinite loop in your
code.</p>

<p>You can reproduce such an error with code like this in a terminal:</p>

<pre><code class="bash">$ pry --noprompt
def foo
  foo
end
=&gt; :foo
foo
SystemStackError: stack level too deep
from /Users/ross/.gem/ruby/2.1.6/gems/pry-0.10.3/lib/pry/pry_instance.rb:355
</code></pre>

<p>Note: for the examples in this post, assume I&rsquo;m using Ruby 2.1 unless otherwise
indicated.</p>

<pre><code class="json">$ ruby -v
ruby 2.1.6p336 (2015-04-13 revision 50298) [x86_64-darwin14.0]
</code></pre>

<p>Prior to Ruby 2.2 and <a href="https://bugs.ruby-lang.org/issues/6216">this issue</a>, the
backtrace for <code>SystemStackError</code> was reduced to one line. That meant, unless
that one line lead you to an obvious culprit in your source code, it
would be very difficult to unravel the method calls causing the stack to overflow.</p>

<p>So, first step in debugging the <code>SystemStackError</code> is upgrade to Ruby 2.2!</p>

<p>In case that&rsquo;s not possible, there&rsquo;s still hope. Let&rsquo;s try using information
from the error first. Here&rsquo;s the method containing <a href="https://github.com/rossta/montrose/blob/e5b7a12f6832b4f971a52b27800cefe144ecd399/lib/montrose/options.rb#L204">the line in the backtrace</a>:</p>

<pre><code class="ruby"># lib/montrose/options.rb:204

def map_arg(arg, &amp;block)
  return nil unless arg

  Array(arg).map(&amp;block)    # line 204
end
</code></pre>

<p>No obvious culprit. This method doesn&rsquo;t call itself and there are multiple callers
of this method in this class.</p>

<p>Let&rsquo;s try rescuing from the error in a test and printing the execution stack
using <a href="http://ruby-doc.org/core-2.2.3/Kernel.html#method-i-caller"><code>Kernel.caller</code></a>. I can isolate the application code that produces the stack overflow in a single test and rescue there.</p>

<pre><code class="ruby">it &quot;a test&quot; do
  # given

  begin
    # when
  rescue SystemStackError
    puts caller
  end

  # then
end
</code></pre>

<p>Here&rsquo;s what I get:</p>

<pre><code class="bash">$ bin/m spec/rfc_spec.rb:426
/Users/ross/dev/rossta/montrose/spec/rfc_spec.rb:434:in `block (2 levels) in &lt;top (required)&gt;&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:108:in `block (3 levels) in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:205:in `capture_exceptions&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:105:in `block (2 levels) in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:256:in `time_it&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:104:in `block in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:334:in `on_signal&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:276:in `with_info_handler&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest/test.rb:103:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:781:in `run_one_method&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:308:in `run_one_method&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:296:in `block (2 levels) in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:295:in `each&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:295:in `block in run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:334:in `on_signal&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:321:in `with_info_handler&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:294:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:155:in `block in __run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:155:in `map&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:155:in `__run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/minitest-5.8.3/lib/minitest.rb:129:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/lib/m/runners/minitest_5.rb:9:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/lib/m/executor.rb:26:in `execute&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/lib/m/runner.rb:17:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/lib/m.rb:13:in `run&#39;
/Users/ross/.gem/ruby/2.1.6/gems/m-1.4.2/bin/m:4:in `&lt;top (required)&gt;&#39;
bin/m:16:in `load&#39;
bin/m:16:in `&lt;main&gt;&#39;
</code></pre>

<p>The backtrace points to lines in minitest. Since I&rsquo;ve been running tests prior
to this isssue successfully, it&rsquo;s unlikely minitest is the source of the stack overflow error. So rescuing from <code>SytemStackError</code> doesn&rsquo;t help us either.</p>

<p>Luckily, we have <a href="https://gist.github.com/jbgo/4493822">this gist</a> from
<a href="https://github.com/jbgo">@jbgo</a> who highlighted a special feature in Ruby for
tracing function events: <a href="http://ruby-doc.org/core-1.9.3/Kernel.html#method-i-set_trace_func"><code>Kernel.set_trace_func</code></a>.</p>

<p>Here&rsquo;s the example from the docs:</p>

<pre><code class="ruby">class Test
  def test
    a = 1
    b = 2
  end
end

set_trace_func proc { |event, file, line, id, binding, classname|
  printf &quot;%8s %s:%-2d %10s %8s\n&quot;, event, file, line, id, classname
}
t = Test.new
t.test

    line prog.rb:11               false
  c-call prog.rb:11        new    Class
  c-call prog.rb:11 initialize   Object
c-return prog.rb:11 initialize   Object
c-return prog.rb:11        new    Class
    line prog.rb:12               false
    call prog.rb:2        test     Test
    line prog.rb:3        test     Test
    line prog.rb:4        test     Test
  return prog.rb:4        test     Test
</code></pre>

<p>The method <code>set_trace_func</code> sets a global proc to be invoked in response to
runtime events including the following:</p>

<ul>
<li><code>c-call</code> a C-language routine</li>
<li><code>c-return</code> return from a C-language routine</li>
<li><code>call</code> a Ruby method</li>
<li><code>class</code> start a class or module definition</li>
<li><code>end</code> finish a class or module definition</li>
<li><code>line</code> execute code on a new line</li>
<li><code>raise</code> raise an exception</li>
<li><code>return</code> return from a Ruby method</li>
</ul>

<p>Since we want to isolate the Ruby method causing the infinite loop in our stack,
we&rsquo;ll log the line info for <code>call</code> events:</p>

<pre><code class="ruby"># spec/spec_helper.rb

$trace_out = open(&quot;trace.txt&quot;)

set_trace_func proc { |event, file, line, id, binding, classname|
  if event == &#39;call&#39;
    $trace_out.puts &quot;#{file}:#{line} #{classname}##{id}&quot;
  end
}
</code></pre>

<p>Re-running the test produces a <code>trace.txt</code> file that records all the Ruby method
calls encountered during execution. Inspecting this log, we hope to find a
repeating pattern of an identical list of method calls.</p>

<p>In my case, the start of each pattern pointed to another line in my source where
the stack originates:</p>

<pre><code>/Users/ross/dev/rossta/montrose/lib/montrose/stack.rb:38 Montrose::Stack#advance
/Users/ross/dev/rossta/montrose/lib/montrose/frequency/yearly.rb:4 Montrose::Frequency::Yearly#include?
/Users/ross/dev/rossta/montrose/lib/montrose/frequency.rb:51 Montrose::Frequency#matches_interval?
...
/Users/ross/dev/rossta/montrose/lib/montrose/stack.rb:38 Montrose::Stack#advance
/Users/ross/dev/rossta/montrose/lib/montrose/frequency/yearly.rb:4 Montrose::Frequency::Yearly#include?
/Users/ross/dev/rossta/montrose/lib/montrose/frequency.rb:51 Montrose::Frequency#matches_interval?
...
/Users/ross/dev/rossta/montrose/lib/montrose/stack.rb:38 Montrose::Stack#advance
/Users/ross/dev/rossta/montrose/lib/montrose/frequency/yearly.rb:4 Montrose::Frequency::Yearly#include?
/Users/ross/dev/rossta/montrose/lib/montrose/frequency.rb:51 Montrose::Frequency#matches_interval?
...
</code></pre>

<p>A useful trick is to keep the trace routine in a separate file that you can
incorporate with an environment variable. You can also leverage <code>Kernel.caller</code>
here and only log when the stack exceeds an arbitrarily large size.</p>

<pre><code class="ruby"># spec/support/trace.rb

if ENV[&quot;TRACE&quot;]
  $stack_size = ENV[&quot;TRACE&quot;].to_i
  $trace_out = open(&quot;trace.txt&quot;)

  set_trace_func proc { |event, file, line, id, binding, classname|
    if event == &#39;call&#39; &amp;&amp; caller.length &gt; $stack_size
      $trace_out.puts &quot;#{file}:#{line} #{classname}##{id}&quot;
    end
  }
end
</code></pre>

<p>In my <a href="https://github.com/rossta/montrose">Montrose</a> gem, <a href="https://github.com/rossta/montrose/blob/9600e0b63bde342011b3b9b1e29ab9f76f5f69c3/spec/support/trace.rb">this file</a> gets loaded during every test run but the <code>set_trace_func</code> hook will
only be evaluated when the <code>TRACE</code> environment variable is present:</p>

<pre><code>$ TRACE=500 bin/m spec/montrose/recurrence_spec.rb
</code></pre>

<p>Again, you won&rsquo;t need to resort to this workaround for <code>SystemStackError</code> in Ruby
2.2+, but keep this in mind next time you get stuck &ldquo;in the loop&rdquo;.</p>


    </article>
    <hr />
    <section class="margin-bottom double">
      <p>
        Did you like this post? Do me a favor: <a target="_blank" href="https://twitter.com/intent/tweet?text=Debugging%20SystemStackError%20-%20rossta.net&amp;url=rossta.net%3A4567%2Fblog%2Fdebugging-systemstackerror.html">share it on Twitter</a>,
          <a href="https://twitter.com/rossta">follow me - @rossta</a>,
          and sign up for my newsletter. Thanks!
        </p>
      </section>
    </section>
    <section class="signup-form-standalone margin-bottom double">
      <!-- Begin MailChimp Signup Form -->
<div class="signup-form">
  <h3>LEVEL UP your web development</h3>
  <p>Sign up for my occasional newsletter on professional Ruby and Javascript for the web.</p>
  <div id="mc_embed_signup">
    <form action="//rossta.us6.list-manage.com/subscribe/post?u=8ce159842b5c98cecb4ebdf16&amp;id=96030b0bda" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
      <div id="mc_embed_signup_scroll">

        <div class="row">
          <div class="large-10 columns">
            <div class="row collapse">
              <div class="large-8 small-7 columns">
                <input type="email" placeholder="Your email..." value="" name="EMAIL" class="required email" id="mce-EMAIL">
              </div>
              <div class="large-4 small-5 columns">
                <input type="submit" value="Sign me up!" name="subscribe" id="mc-embedded-subscribe" class="button postfix">
              </div>
            </div>
          </div>
        </div>

        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display:none"></div>
          <div class="response" id="mce-success-response" style="display:none"></div>
        </div>
        <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
        <div style="position: absolute; left: -5000px;"><input type="text" name="b_8ce159842b5c98cecb4ebdf16_96030b0bda" tabindex="-1" value=""></div>
      </div>

      <input type="hidden" name="SIGNUP_LOCATION" id="signup_location" value="blog/2016-01-12-debugging-systemstackerror.html" />
      <input type="hidden" name="SIGNUP_TAGS" id="signup_tags" value="Ruby" />
    </form>
  </div>

  <!--End mc_embed_signup-->
</div>

    </section>
    <section class="margin-bottom double">
      <p>
        Published on Jan 12, 2016
    </p>
  </section>
    <hr />
    <section class="comments">
      <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname  = "rosskaff";
    var disqus_identifier = "debugging-systemstackerror";
    var disqus_title      = "Debugging SystemStackError";
    var disqus_url        = "https://rossta.net/blog/debugging-systemstackerror.html";

    var disqus_config = function () {
        this.page.url = disqus_url;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = disqus_identifier; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.title = disqus_title;
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//rosskaff.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<!-- <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a> -->

    </section>

      </section>
    </div>
    
    <footer>
  <div class="row">
    <img class="turtle" src="/assets/images/turtle-logo-096698b6.svg" />
    <section class="large-6 columns">
      <h5>Most Popular</h5>
      <ul>
          <li><a href="/blog/how-to-specify-local-ruby-gems-in-your-gemfile.html">How to specify local Ruby gems in your Gemfile</a></li>
          <li><a href="/blog/web-push-notifications-from-rails.html">Sending Web Push Notifications from Rails</a></li>
          <li><a href="/blog/a-ruby-antihero-thread-pool.html">Thread Pool - A Ruby Antihero</a></li>
          <li><a href="/blog/what-i-learned-about-hanami.html">What I learned building an app in Hanami</a></li>
          <li><a href="/blog/service-worker-on-rails.html">Service Worker on Rails</a></li>
      </ul>
    </section>
    <section class="large-3 columns">
      <h5>Categories</h5>
      <ul>
          <li><a href="/blog/tags/ruby.html">Ruby</a></li>
          <li><a href="/blog/tags/rails.html">Rails</a></li>
          <li><a href="/blog/tags/javascript.html">JavaScript</a></li>
          <li><a href="/blog/tags/rspec.html">RSpec</a></li>
          <li><a href="/blog/tags/process.html">Process</a></li>
      </ul>
    </section>
    <section class="large-3 columns">
      <h5>Contact</h5>
      <ul>
        <li><a href="mailto:ross@rossta.net">email</a></li>
        <li><a href="https://twitter.com/rossta">twitter</a></li>
        <li><a href="https://github.com/rossta">github</a></li>
        <li><a href="https://stackoverflow.com/users/771838/rossta?tab=profile">stackoverflow</a></li>
        <li><a href="https://www.linkedin.com/in/rosskaffenberger">linkedin</a></li>
      </ul>
    </section>
  </div>
  <p class="copyright small subtle center">
    © 2016 Ross Kaffenberger. All rights reserved.
  </p>
</footer>

    <script src="/assets/javascripts/index.bundle-33458126.js"></script>
    
    <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.1.0";
analytics.load("NdBtrprkAGAjQryMShljRdVf90saElAU");
analytics.page()
window.$.tracking.flush(analytics);
}}();
</script>

  </body>
</html>
